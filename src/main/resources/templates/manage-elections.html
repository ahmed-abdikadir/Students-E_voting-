<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Manage Elections</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: capitalize;
        }
        .status-created {
            background-color: #e7f1ff;
            color: #0056b3;
        }
        .status-open {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .status-closed {
            background-color: #ffebee;
            color: #c62828;
        }
        .status-unknown {
            background-color: #f5f5f5;
            color: #616161;
        }
        .button {
            margin: 2px;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .button-danger {
            background-color: #dc3545;
            color: white;
        }
        .button-success {
            background-color: #28a745;
            color: white;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .alert {
            padding: 12px 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Manage Elections</h1>

    <!-- Success/Error Messages -->
    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

    <!-- Create Election Form -->
    <div class="form-container" style="margin-bottom: 40px;">
        <h2>Create New Election</h2>
        <form th:action="@{/admin/elections/create}" method="post">
            <div class="form-group">
                <label for="name">Election Name:</label>
                <input type="text" id="name" name="name" required>
            </div>
            <button type="submit" class="button">Create Election</button>
        </form>
    </div>

    <!-- Election List -->
    <h2>Existing Elections</h2>
    <table class="table">
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="election : ${elections}">
            <td th:text="${election.id}"></td>
            <td th:text="${election.name}"></td>
            <td>
                <span class="status-badge" 
                      th:class="'status-badge status-' + ${election.status?.name()?.toLowerCase() ?: 'unknown'}"
                      th:text="${election.status?.name()?.toLowerCase()}">
                </span>
            </td>
            <td class="actions">
                <form th:action="@{/admin/elections/open/{id}(id=${election.id})}" method="post" style="display: inline;" th:if="${election.status?.name() == 'CREATED'}">
                    <button type="submit" class="button button-success" 
                            title="Open this election for voting">
                        Open
                    </button>
                </form>
                <form th:action="@{/admin/elections/close/{id}(id=${election.id})}" method="post" style="display: inline;" th:if="${election.status?.name() == 'OPEN'}">
                    <button type="submit" class="button button-success"
                            title="Close this election to prevent further voting">
                        Close
                    </button>
                </form>
                <span th:if="${election.status?.name() == 'CLOSED'}" class="text-muted" style="margin-right: 5px;">
                    Election closed
                </span>
                <button type="button" class="button button-danger" 
                        th:data-id="${election.id}"
                        onclick="confirmDeleteElection(this)"
                        title="Delete this election">
                    Delete
                </button>
            </td>
        </tr>
        </tbody>
    </table>

    <a th:href="@{/admin/dashboard}" class="button" style="background-color: #6c757d; margin-top: 40px;">Back to Admin Panel</a>
</div>

<script th:inline="javascript">
    function confirmDeleteElection(button) {
        if (confirm('Are you sure you want to delete this election? This action cannot be undone and will also delete all associated votes and candidates.')) {
            const electionId = button.getAttribute('data-id');
            console.log('Attempting to delete election with ID:', electionId);
            
            // Using direct DELETE method with the correct endpoint
            fetch(`/admin/elections/delete/${electionId}`, {
                method: 'DELETE',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Content-Type:', response.headers.get('content-type'));
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json().then(data => {
                        return { ok: response.ok, data: data };
                    });
                } else {
                    // Handle text response
                    return response.text().then(text => {
                        return { ok: response.ok, data: { message: text } };
                    });
                }
            })
            .then(result => {
                if (!result.ok) {
                    throw new Error(result.data.message || 'Failed to delete election');
                }
                console.log('Success:', result.data);
                // Show success message
                alert('Election deleted successfully');
                // Reload the page to see the updated list
                window.location.reload();
            })
            .catch(error => {
                console.error('Error details:', error);
                alert(error.message || 'Failed to delete election. Please try again.');
            });
        }
    }
</script>
</body>
</html>
